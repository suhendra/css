# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://coffeescript.org/
jQuery ->
  drawChart = ->
    counter_id = $('#counter_id').val()
    range_type = $('#range_type').val()
    date_start = $('#date_start').val()
    date_end = $('#date_end').val()
    user_id = $('#user_id').val()
    jsonData = $.ajax(
      url: '/entries/get_reports?counter_id=' + counter_id + '&range_type=' + range_type + '&date_start=' + date_start + '&date_end=' + date_end + '&user_id=' + user_id
      dataType: 'json'
      async: false).responseText
    obj = JSON.parse(jsonData)
    cols = obj.cols
    rows = obj.rows
    subtitle = obj.subtitle
    dataTable = []
    dataTable.push cols
    for a of rows
      `a = a`
      dataTable.push rows[a]
    data = google.visualization.arrayToDataTable(dataTable)
    options =
      chart:
        title: 'Feedback Reports'
        subtitle: subtitle
      colors: ['#4285f4', '#0f9d58', '#f4b400', '#db4437']
    chart = new (google.charts.Bar)(document.getElementById('columnchart_material'))
    chart.draw data, google.charts.Bar.convertOptions(options)
    return

  $('#counter_id, #user_id, #range_type').select2 theme: 'bootstrap'
  google.charts.load 'current', 'packages': [ 'bar' ]
  google.charts.setOnLoadCallback drawChart
  $('#counter_id').on 'change', ->
    if $(this).attr('id') == 'counter_id'
      c_id = $(this).val();
      $.get '/users/get_users.json', { counter_id: c_id }, (data) ->
        # Remove the existing options in the responses drop down:
        $('#user_id').html ''
        # Loop over the json and populate the Responses options:
        $('#user_id').append '<option value=\'\'>all</option>'
        $.each data, (index, value) ->
          $('#user_id').append '<option value=\'' + value.id + '\'>' + value.firstname + '</option>'
    return
  $('#counter_id, #user_id, #range_type').on 'change', ->
    drawChart()
    return

  $('#datetimepicker1').datetimepicker
    format: 'DD-MM-YYYY'
    defaultDate: moment().subtract(1, 'years')
  $('#datetimepicker2').datetimepicker
    format: 'DD-MM-YYYY'
    defaultDate: moment().format('YYYY-MM-DD')
    useCurrent: false
  $('#datetimepicker1').on 'dp.change', (e) ->
    $('#datetimepicker2').data('DateTimePicker').minDate e.date
    drawChart()
    return
  $('#datetimepicker2').on 'dp.change', (e) ->
    $('#datetimepicker1').data('DateTimePicker').maxDate e.date
    drawChart()
    return

# ---
# generated by js2coffee 2.2.0
